{"version":3,"sources":["../src/index.ts","../src/use-query-string-state.ts"],"sourcesContent":["export { useQueryStringState } from \"./use-query-string-state\";\nexport type {\n  QueryString,\n  UseQueryStringStateOptions,\n} from \"./use-query-string-state\";\n","import { useCallback, useEffect, useState } from \"react\";\r\n\r\ntype SetStateAction<S> = S | ((prevState: S) => S);\r\n\r\ntype Dispatch<A> = (value: A) => void;\r\n\r\nconst RESET = \"RESET\";\r\n\r\nexport interface QueryString {\r\n  parse: (str: string) => Record<string, any>;\r\n  stringify: (obj: Record<string, any>) => string;\r\n}\r\n\r\nexport interface UseQueryStringStateOptions<S extends object> {\r\n  onValueChange?: (value: S) => void;\r\n  onPathnameChange?: (pathname: string) => void;\r\n  queryString?: QueryString;\r\n  isSyncPathname?: boolean;\r\n}\r\n\r\nfunction isNumber(num: any) {\r\n  if (typeof num === \"number\") {\r\n    return num - num === 0;\r\n  }\r\n  if (typeof num === \"string\" && num.trim() !== \"\") {\r\n    return Number.isFinite ? Number.isFinite(+num) : isFinite(+num);\r\n  }\r\n  return false;\r\n}\r\n\r\nfunction toNumberable(value: any): any {\r\n  if (Array.isArray(value)) {\r\n    return value.map((item: any) => toNumberable(item));\r\n  }\r\n  switch (typeof value) {\r\n    case \"string\":\r\n      return isNumber(value) ? Number(value) : value;\r\n\r\n    default:\r\n      return value;\r\n  }\r\n}\r\n\r\nfunction parseQueryString<Value>(searchParams: string, initialValue: Value) {\r\n  const output: Record<string, any> = {};\r\n  const urlParams = new URLSearchParams(searchParams);\r\n\r\n  // Set will return only unique keys()\r\n  new Set([...urlParams.keys()]).forEach((key) => {\r\n    output[key] =\r\n      urlParams.getAll(key).length > 1\r\n        ? urlParams.getAll(key)\r\n        : initialValue instanceof Object &&\r\n          key in initialValue &&\r\n          typeof initialValue[key as keyof typeof initialValue] === \"number\"\r\n        ? toNumberable(urlParams.get(key))\r\n        : urlParams.get(key);\r\n  });\r\n\r\n  return output;\r\n}\r\n\r\nfunction stringifyQueryString(obj: Record<string, any>) {\r\n  return Object.entries(obj)\r\n    .flatMap(([key, value]) => {\r\n      if (Array.isArray(value)) {\r\n        return value.map((item) => {\r\n          if (item == undefined || item == null) return;\r\n          return encodeURIComponent(key) + \"=\" + encodeURIComponent(item);\r\n        });\r\n      }\r\n      if (value == undefined || value == null) return;\r\n      return encodeURIComponent(key) + \"=\" + encodeURIComponent(value);\r\n    })\r\n    .join(\"&\");\r\n}\r\n\r\nfunction createQueryString<Value>(initialValue: Value): QueryString {\r\n  return {\r\n    parse: (searchParams) =>\r\n      parseQueryString<Value>(searchParams, initialValue),\r\n    stringify: stringifyQueryString,\r\n  };\r\n}\r\n\r\nexport function useQueryStringState<S extends object>(\r\n  initialValue: Readonly<S>,\r\n  {\r\n    onValueChange,\r\n    onPathnameChange,\r\n    queryString = createQueryString<S>(initialValue),\r\n    isSyncPathname = true,\r\n  }: UseQueryStringStateOptions<S> = {}\r\n): [S, Dispatch<SetStateAction<S>>, Function] {\r\n  const getInitialStateWithQueryString = <S extends object>(\r\n    initialValue: Readonly<S>\r\n  ) => {\r\n    try {\r\n      if (typeof window !== \"undefined\" && isValidUrl(window.location.href)) {\r\n        const url = new URL(window.location.href);\r\n\r\n        for (const k of url.searchParams.keys()) {\r\n          if (!(k in initialValue)) {\r\n            url.searchParams.delete(k);\r\n          }\r\n        }\r\n        const urlParsed = queryString.parse(url.searchParams.toString());\r\n\r\n        return Object.assign({}, initialValue, urlParsed);\r\n      }\r\n      return initialValue;\r\n    } catch (error) {\r\n      console.error(error);\r\n      return initialValue;\r\n    }\r\n  };\r\n\r\n  const [state, _setState] = useState<S>(\r\n    isSyncPathname\r\n      ? getInitialStateWithQueryString<S>(initialValue)\r\n      : initialValue\r\n  );\r\n\r\n  const setState: Dispatch<SetStateAction<S> | typeof RESET> = (value) => {\r\n    const payload =\r\n      value === RESET\r\n        ? initialValue\r\n        : value instanceof Function\r\n        ? value(state)\r\n        : value;\r\n\r\n    _setState(payload);\r\n    onValueChange?.(payload);\r\n\r\n    if (typeof window !== \"undefined\" && isValidUrl(window.location.href)) {\r\n      const url = new URL(window.location.href);\r\n      const parsed = queryString.parse(url.searchParams.toString());\r\n      const searchParams = queryString.stringify(\r\n        Object.assign(parsed, payload)\r\n      );\r\n\r\n      const resultUrl = url.pathname + \"?\" + searchParams;\r\n\r\n      if (onPathnameChange instanceof Function) {\r\n        onPathnameChange(resultUrl);\r\n      } else {\r\n        window.history.pushState(null, \"\", resultUrl);\r\n      }\r\n    }\r\n  };\r\n\r\n  useEffect(() => {\r\n    if (\r\n      typeof window !== \"undefined\" &&\r\n      typeof window.addEventListener === \"function\"\r\n    ) {\r\n      const handlePopState = () => {\r\n        if (isSyncPathname) {\r\n          _setState(getInitialStateWithQueryString<S>(initialValue));\r\n        }\r\n      };\r\n      window.addEventListener(\"popstate\", handlePopState);\r\n      return () => window.removeEventListener(\"popstate\", handlePopState);\r\n    }\r\n  }, [isSyncPathname, initialValue]);\r\n\r\n  const reset = useCallback(\r\n    () => () => {\r\n      setState(RESET);\r\n    },\r\n    []\r\n  );\r\n\r\n  return [state, setState, reset];\r\n}\r\n\r\nfunction isValidUrl(str: string) {\r\n  try {\r\n    new URL(str);\r\n    return true;\r\n  } catch (err) {\r\n    return false;\r\n  }\r\n}\r\n"],"mappings":"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","names":["initialValue"]}